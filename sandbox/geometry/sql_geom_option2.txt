~DeclareVarchar(@dateStamp,20)~
~DeclareInt(@minAcres)~
~DeclareInt(@minPct)~
~DeclareGeometry(@aoiGeom)~
~DeclareGeometry(@aoiGeomFixed)~


-- #BAoiAcres table to contain summary acres for each landunit
CREATE TABLE #BAoiAcres
    ( aoiid INT,
    landunit CHAR(20),
    landunit_acres FLOAT )

	-- #BAoiSoils table contains intersected soil polygon table with geometry
CREATE TABLE #BAoiSoils
    ( polyid INT IDENTITY (1,1),
    aoiid INT,
    landunit CHAR(20),
    mukey INT,
    soilgeom GEOMETRY )


CREATE TABLE #BAoiTable
    ( aoiid INT IDENTITY (1,1),
    landunit CHAR(20),
    aoigeom GEOMETRY )
;

-- #AoiSoils2 table contains Soil geometry with landunits
CREATE TABLE #BAoiSoils2
    ( aoiid INT,
    polyid INT,
    landunit CHAR(20),
    mukey INT,
    poly_acres FLOAT,
    soilgeog GEOGRAPHY )
;


-- Insert identifier string and WKT geometry for each AOI polygon after this...
 
SELECT @aoiGeom = GEOMETRY::STGeomFromText('MULTIPOLYGON (((
-98.92789 37.62969258178528, -98.92781453383243 37.62969206018085, -98.92773909065578 37.62969049552648, -98.92766369345392 37.62968788829886, -98.92758836519674 37.62968423929225, -98.9275131288331 37.629679549618366, -98.9274380072839 37.629673820705904, -98.92736302343498 37.62966705430018, -98.92728820013022 37.6296592524626, -98.92721356016465 37.62965041757001, -98.92713912627734 37.62964055231396, -98.92706492114456 37.629629659699916, -98.92699096737289 37.62961774304633, -98.9269172874923 37.62960480598362, -98.92684390394926 37.62959085245306, -98.92677083909996 37.629575886705624, -98.92669811520342 37.62955991330062, -98.92662575441477 37.62954293710434, -98.9265537787785 37.6295249632886, -98.92648221022164 37.629505997329126, -98.92641107054723 37.62948604500387, -98.92634038142758 37.6294651123913, -98.92627016439765 37.62944320586853, -98.92620044084859 37.62942033210935, -98.92613123202108 37.62939649808222, -98.92606255899899 37.62937171104812, -98.92599444270286 37.62934597855841, -98.92592690388358 37.62931930845239, -98.92585996311604 37.62929170885505, -98.92579364079286 37.62926318817455, -98.9257279571182 37.62923375509959, -98.92566293210157 37.629203418596866, -98.92559858555178 37.62917218790826, -98.92553493707085 37.62914007254807, -98.92547200604804 37.62910708230008, -98.92540981165402 37.629073227214604, -98.92534837283493 37.6290385176054, -98.92528770830667 37.629002964046556, -98.92522783654915 37.62896657736921, -98.92516877580077 37.62892936865833, -98.92511054405264 37.62889134924926, -98.92505315904337 37.62885253072432, -98.92499663825348 37.62881292490926, -98.92494099890011 37.628772543869644, -98.92488625793186 37.628731399907174, -98.92483243202352 37.62868950555595, -98.92477953757101 37.62864687357867, -98.92472759068646 37.6286035169627, -98.92467660719322 37.62855944891613, -98.9246266026211 37.62851468286379, -98.92457759220154 37.628469232443074, -98.92452959086314 37.62842311149989, -98.92448261322696 37.62837633408435, -98.92443667360209 37.62832891444652, -98.92439178598138 37.62828086703212, -98.92434796403714 37.62823220647804, -98.92430522111687 37.628182947607954, -98.92426357023939 37.628133105427764, -98.92422302409068 37.628082695121044, -98.92418359502015 37.6280317320444, -98.92414529503687 37.62798023172281, -98.9241081358058 37.627928209844846, -98.92407212864438 37.627875682257965, -98.92403728451902 37.62782266496364, -98.92400361404175 37.62776917411249, -98.92397112746701 37.627715225999324, -98.92393983468853 37.627660837058265, -98.92390974523627 37.62760602385765, -98.92388086827368 37.62755080309503, -98.92385321259465 37.627495191592075, -98.92382678662108 37.62743920628945, -98.92380159840015 37.62738286424163, -98.923777655602 37.62732618261177, -98.92375496551725 37.627269178666374, -98.92373353505496 37.62721186977012, -98.92371337074039 37.62715427338055, -98.92369447871305 37.627096407042714, -98.92367686472487 37.62703828838388, -98.92366053413838 37.626979935108125, -98.92364549192517 37.626921364990956, -98.92363174266434 37.62686259587389, -98.92361929054107 37.626803645659, -98.92360813934536 37.62674453230353, -98.923598292471 37.62668527381434, -98.9235897529143 37.62662588824246, -98.92358252327345 37.62656639367759, -98.92357660574753 37.6265068082426, -98.92357200213594 37.626447150087984, -98.92356871383784 37.626387437386335, -98.92356674185169 37.626327688326846, -98.92356608677503 37.62626792110973, -98.92356674880422 37.62620815394067, -98.9235687277344 37.62614840502529, -98.92357202295962 37.62608869256364, -98.92357663347296 37.626029034744604, -98.92358255786684 37.625969449740374, -98.92358979433352 37.62590995570094, -98.92359834066555 37.62585057074849, -98.92360819425657 37.62579131297199, -98.92361935210201 37.62573220042161, -98.92363181080003 37.62567325110323, -98.92364556655258 37.62561448297298, -98.92366061516658 37.625555913931755, -98.92367695205515 37.625497561819735, -98.92369457223901 37.625439444411036, -98.92371347034809 37.6253815794082, -98.92373364062304 37.62532398443686, -98.92375507691709 37.62526667704035, -98.92377777269786 37.62520967467439, -98.92380172104939 37.62515299470171, -98.92382691467427 37.625096654386816, -98.92385334589578 37.625040670890755, -98.92388100666032 37.62498506126578, -98.92390988853985 37.624929842450285, -98.92393998273441 37.624875031263564, -98.92397128007485 37.62482064440071, -98.92400377102562 37.624766698427536, -98.92403744568766 37.62471320977555, -98.92407229380142 37.624660194736876, -98.92410830475002 37.62460766945941, -98.92414546756245 37.62455564994178, -98.92418377091691 37.624504152028585, -98.9242232031443 37.624453191405465, -98.92426375223171 37.6244027835944, -98.92430540582617 37.624352943948956, -98.92434815123838 37.62430368764963, -98.9243919754465 37.62425502969917, -98.92443686510022 37.6242069849181, -98.9244828065248 37.6241595679401, -98.92452978572521 37.62411279320763, -98.92457778839042 37.624066674967494, -98.92462679989775 37.62402122726654, -98.9246768053173 37.623976463947315, -98.9247277894166 37.62393239864392, -98.92477973666506 37.623889044777826, -98.92483263123891 37.62384641555378, -98.9248864570259 37.62380452395578, -98.92494119763025 37.62376338274319, -98.92499683637756 37.623723004446745, -98.92505335632002 37.62368340136481, -98.92511074024152 37.623644585559624, -98.92516897066282 37.62360656885362, -98.92522802984702 37.6235693628258, -98.9252878998048 37.623532978808285, -98.92534856230004 37.62349742788276, -98.92540999885526 37.62346272087719, -98.92547219075735 37.62342886836246, -98.92553511906317 37.62339588064923, -98.9255987646054 37.623363767784696, -98.92566310799833 37.62333253954961, -98.92572812964379 37.623302205455275, -98.9257938097371 37.62327277474066, -98.92586012827309 37.62324425636955, -98.92592706505222 37.62321665902788, -98.92599459968675 37.62318999112102, -98.92606271160683 37.62316426077129, -98.92613138006698 37.62313947581541, -98.92620058415216 37.623115643802166, -98.92627030278429 37.623092771990116, -98.9263405147287 37.62307086734533, -98.92641119860042 37.62304993653932, -98.92648233287089 37.62302998594699, -98.92655389587436 37.6230110216447, -98.92662586581461 37.62299304940839, -98.9266982207715 37.62297607471186, -98.92677093870766 37.62296010272509, -98.92684399747523 37.622945138312645, -98.92691737482258 37.622931186032226, -98.92699104840109 37.62291825013325, -98.92706499577196 37.6229063345556, -98.92713919441302 37.62289544292838, -98.9272136217256 37.62288557856883, -98.92728825504143 37.622876744481324, -98.92736307162954 37.62286894335645, -98.92743804870311 37.62286217757016, -98.9275131634265 37.62285644918312, -98.92758839292216 37.62285175994, -98.9276637142776 37.62284811126898, -98.92773910455234 37.622845504281344, -98.92781454078496 37.6228439397711, -98.92789 37.62284341821473, -98.92796545921505 37.6228439397711, -98.92804089544767 37.622845504281344, -98.92811628572241 37.62284811126898, -98.92819160707785 37.62285175994, -98.92826683657351 37.62285644918312, -98.9283419512969 37.62286217757016, -98.92841692837048 37.62286894335645, -98.92849174495858 37.622876744481324, -98.92856637827443 37.62288557856883, -98.92864080558701 37.62289544292838, -98.92871500422805 37.6229063345556, -98.92878895159892 37.62291825013325, -98.92886262517743 37.622931186032226, -98.92893600252478 37.622945138312645, -98.92900906129235 37.62296010272509, -98.92908177922851 37.62297607471186, -98.9291541341854 37.62299304940839, -98.92922610412565 37.6230110216447, -98.92929766712913 37.62302998594699, -98.92936880139959 37.62304993653932, -98.92943948527132 37.62307086734533, -98.92950969721572 37.623092771990116, -98.92957941584787 37.623115643802166, -98.92964861993305 37.62313947581541, -98.92971728839318 37.62316426077129, -98.92978540031326 37.62318999112102, -98.92985293494779 37.62321665902788, -98.92991987172692 37.62324425636955, -98.92998619026292 37.62327277474066, -98.93005187035622 37.623302205455275, -98.93011689200168 37.62333253954961, -98.93018123539461 37.623363767784696, -98.93024488093684 37.62339588064923, -98.93030780924268 37.62342886836246, -98.93037000114475 37.62346272087719, -98.93043143769998 37.62349742788276, -98.93049210019521 37.623532978808285, -98.930551970153 37.6235693628258, -98.93061102933719 37.62360656885362, -98.9306692597585 37.623644585559624, -98.93072664367999 37.62368340136481, -98.93078316362246 37.623723004446745, -98.93083880236978 37.62376338274319, -98.9308935429741 37.62380452395578, -98.9309473687611 37.62384641555378, -98.93100026333495 37.623889044777826, -98.93105221058342 37.62393239864392, -98.9311031946827 37.623976463947315, -98.93115320010226 37.62402122726654, -98.93120221160959 37.624066674967494, -98.93125021427481 37.62411279320763, -98.93129719347522 37.6241595679401, -98.9313431348998 37.6242069849181, -98.93138802455353 37.62425502969917, -98.93143184876163 37.62430368764963, -98.93147459417384 37.624352943948956, -98.9315162477683 37.6244027835944, -98.93155679685573 37.624453191405465, -98.93159622908311 37.624504152028585, -98.93163453243757 37.62455564994178, -98.93167169524999 37.62460766945941, -98.9317077061986 37.624660194736876, -98.93174255431236 37.62471320977555, -98.9317762289744 37.624766698427536, -98.93180871992516 37.62482064440071, -98.9318400172656 37.624875031263564, -98.93187011146017 37.624929842450285, -98.9318989933397 37.62498506126578, -98.93192665410423 37.625040670890755, -98.93195308532574 37.625096654386816, -98.93197827895062 37.62515299470171, -98.93200222730215 37.62520967467439, -98.93202492308292 37.62526667704035, -98.93204635937697 37.62532398443686, -98.93206652965192 37.6253815794082, -98.932085427761 37.625439444411036, -98.93210304794486 37.625497561819735, -98.93211938483343 37.625555913931755, -98.93213443344743 37.62561448297298, -98.93214818919999 37.62567325110323, -98.932160647898 37.62573220042161, -98.93217180574344 37.62579131297199, -98.93218165933446 37.62585057074849, -98.9321902056665 37.62590995570094, -98.93219744213317 37.625969449740374, -98.93220336652706 37.626029034744604, -98.93220797704039 37.62608869256364, -98.93221127226562 37.62614840502529, -98.93221325119579 37.62620815394067, -98.93221391322498 37.62626792110973, -98.93221325814832 37.626327688326846, -98.93221128616219 37.626387437386335, -98.93220799786407 37.626447150087984, -98.93220339425248 37.6265068082426, -98.93219747672656 37.62656639367759, -98.93219024708571 37.62662588824246, -98.93218170752903 37.62668527381434, -98.93217186065465 37.62674453230353, -98.93216070945896 37.626803645659, -98.93214825733567 37.62686259587389, -98.93213450807484 37.626921364990956, -98.93211946586163 37.626979935108125, -98.93210313527514 37.62703828838388, -98.93208552128696 37.627096407042714, -98.93206662925962 37.62715427338055, -98.93204646494505 37.62721186977012, -98.93202503448276 37.627269178666374, -98.93200234439803 37.62732618261177, -98.93197840159986 37.62738286424163, -98.93195321337893 37.62743920628945, -98.93192678740537 37.627495191592075, -98.93189913172633 37.62755080309503, -98.93187025476374 37.62760602385765, -98.9318401653115 37.627660837058265, -98.93180887253301 37.627715225999324, -98.93177638595827 37.62776917411249, -98.931742715481 37.62782266496364, -98.93170787135564 37.627875682257965, -98.93167186419421 37.627928209844846, -98.93163470496316 37.62798023172281, -98.93159640497987 37.6280317320444, -98.93155697590933 37.628082695121044, -98.93151642976062 37.628133105427764, -98.93147477888314 37.628182947607954, -98.93143203596289 37.62823220647804, -98.93138821401863 37.62828086703212, -98.93134332639794 37.62832891444652, -98.93129738677307 37.62837633408435, -98.93125040913687 37.62842311149989, -98.93120240779847 37.628469232443074, -98.93115339737892 37.62851468286379, -98.93110339280679 37.62855944891613, -98.93105240931355 37.6286035169627, -98.931000462429 37.62864687357867, -98.93094756797649 37.62868950555595, -98.93089374206815 37.628731399907174, -98.9308390010999 37.628772543869644, -98.93078336174653 37.62881292490926, -98.93072684095665 37.62885253072432, -98.93066945594738 37.62889134924926, -98.93061122419925 37.62892936865833, -98.93055216345086 37.62896657736921, -98.93049229169334 37.629002964046556, -98.93043162716508 37.6290385176054, -98.93037018834599 37.629073227214604, -98.93030799395197 37.62910708230008, -98.93024506292916 37.62914007254807, -98.93018141444823 37.62917218790826, -98.93011706789844 37.629203418596866, -98.93005204288181 37.62923375509959, -98.92998635920715 37.62926318817455, -98.92992003688397 37.62929170885505, -98.92985309611643 37.62931930845239, -98.92978555729715 37.62934597855841, -98.92971744100102 37.62937171104812, -98.92964876797893 37.62939649808222, -98.92957955915143 37.62942033210935, -98.92950983560236 37.62944320586853, -98.92943961857245 37.6294651123913, -98.92936892945278 37.62948604500387, -98.92929778977837 37.629505997329126, -98.92922622122151 37.6295249632886, -98.92915424558524 37.62954293710434, -98.92908188479659 37.62955991330062, -98.92900916090005 37.629575886705624, -98.92893609605075 37.62959085245306, -98.92886271250771 37.62960480598362, -98.92878903262712 37.62961774304633, -98.92871507885545 37.629629659699916, -98.92864087372269 37.62964055231396, -98.92856643983536 37.62965041757001, -98.92849179986979 37.6296592524626, -98.92841697656505 37.62966705430018, -98.92834199271613 37.629673820705904, -98.92826687116691 37.629679549618366, -98.92819163480327 37.62968423929225, -98.92811630654609 37.62968788829886, -98.92804090934423 37.62969049552648, -98.92796546616758 37.62969206018085, -98.92789 37.62969258178528
)))', 4326); 
SELECT @aoiGeomFixed = @aoiGeom.MakeValid().STUnion(@aoiGeom.STStartPoint()); 
INSERT INTO #BAoiTable ( landunit, aoigeom )  
VALUES ('T9981 Fld3', @aoiGeomFixed); 

INSERT INTO #BAoiAcres (aoiid, landunit, landunit_acres )
    SELECT  aoiid, landunit,
    SUM( ROUND( ( ( GEOGRAPHY::STGeomFromWKB(aoigeom.STAsBinary(), 4326 ).STArea() ) / 4046.8564224 ), 3 ) ) AS landunit_acres
    FROM #BAoiTable
    GROUP BY aoiid, landunit

INSERT INTO #BAoiSoils (aoiid, landunit, mukey, soilgeom)
    SELECT A.aoiid, A.landunit, M.mukey, M.mupolygongeo.STIntersection(A.aoigeom ) AS soilgeom
    FROM mupolygon M, #BAoiTable A
    WHERE mupolygongeo.STIntersects(A.aoigeom) = 1

-- Populate #AoiSoils2 Soil geometry with landunit attribute
INSERT INTO #BAoiSoils2
    SELECT aoiid, polyid, landunit, mukey, ROUND((( GEOGRAPHY::STGeomFromWKB(soilgeom.STAsBinary(), 4326 ).STArea() ) / 4046.8564224 ), 3 ) AS poly_acres, GEOGRAPHY::STGeomFromWKB(soilgeom.STAsBinary(), 4326 ) AS soilgeog
    FROM #BAoiSoils
;

-- Populate #M2 soil map unit acres, aggregated by mukey (merges polygons together)
--INSERT INTO #M2
    SELECT DISTINCT M1.aoiid,  M1.mukey,
    ROUND (SUM (M1.poly_acres) OVER(PARTITION BY M1.landunit, M1.mukey), 3) AS mapunit_acres
    FROM #BAoiSoils2 AS M1
    GROUP BY M1.aoiid, M1.landunit, M1.mukey, M1.poly_acres
;
