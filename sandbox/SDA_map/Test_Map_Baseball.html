


<!DOCTYPE HTML>
<html>
<head>
 <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
	<title>Potential Baseball Infield Soil Source</title>
<!-- Start Map -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<!-- End Map -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>



<!-- Start Map -->	

	
	
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://turbo87.github.io/sidebar-v2/css/leaflet-sidebar.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="crossorigin=""/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="crossorigin=""></script>
  

	

	<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.2/wicket-leaflet.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3&libraries=places&sensor=false"></script>
<!-- End Map -->	
	
	<style type="text/css">
        .scrolltable {
            overflow-x: scroll;
            height: 100%;
            display: flex;
            display: -webkit-flex;
            flex-direction: column;
            -webkit-flex-direction: column;
        }
        .scrolltable > .header {
        }
        .scrolltable > .body {
            /*noinspection CssInvalidPropertyValue*/
            width: -webkit-fit-content;
            overflow-y: scroll;
            flex: 1;
            -webkit-flex: 1;
        }
        th, td {
            min-width: 25px;
        }
        /* an outside constraint to react against */
        #constrainer {
            width: 400px;
            height: 200px;
        }
        #constrainer2 {
            width: 400px;
            overflow-x: scroll;
        }
        #constrainer2 table {
            overflow-y: scroll;
        }
        #constrainer2 tbody {
            overflow-x: scroll;
            display: block;
            height: 200px;
        }
        #constrainer2 thead {
            display: table-row;
        }
        /* only styling below here */
        #constrainer, #constrainer2 {
            border: 1px solid lightgrey;
        }
        table {
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid gray;
        }
        th {
            background-color: lightgrey;
            border-width: 1px;
        }
        td {
            border-width: 1px;
        }
        tr:first-child td {
            border-top-width: 0;
        }
        tr:nth-child(even) {
            background-color: #eee;
        }
    </style>
	
	<!--Start Map-->
	<style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

		div.margin-indented {
			margin-left: 100px;
			margin-right: 100px;
		}
		
		#drawSaveDiv {
			width: 250px;
			text-align: center;
			position: absolute;
			border: 1px solid black;
			background-color: gainsboro;
			left: 40%; top:30%;
			visibility: hidden;
		}
	</style>
	
	<!--End Map-->
</head>
<body>
<b>
		<font color='red'>
<h3>Potential Baseball Baseball Infield Soil Source</h3>
		</font>
	</b>
<h4> State Soil Data Access (SDA) Report </h4>
	<p>
	An SDA-populated select list is used to pick a state and SSA which enables creation of a "Potential Baseball Infield Soil Source" based upon those selections. Baseball infields have been historically constructed with optimum drainage and particle size in mind.  Baseball infield areas have a specified range of characteristics which this interpretation uses to identify soil map units with the highest potential for these materials.
	This table gives information about the soils as potential sources of soil material suitable for baseball field. Normal compaction, minor processing, and other standard construction practices are assumed. Criteria for this report is sand content between 60 and 65 percent and silt to clay ratio is between 0.75 to 1. Ideally, medium sand to total sand ratio should be greater than 0.5  
	Baseball infields have been historically constructed with optimum drainage and particle size in mind.  Baseball infield areas have a specified range of characteristics which this interpretation uses to identify soil map units with the highest potential for these materials.  
	<br>
	<a href='#reportref'> For more information about the table, </a>
	</p>
	<a name='top'>
	
	<!-- The following "div" tag will be updated with the retrieved data
		After the first selection the "(select a state)" will disappear -->
	<select id="selectId1" onchange="ChangeSelectedState(event)">
		<option value='' style="display: none" id="remove">(select a state)</option>
	</select>
	
	<div id="selectedStateId"><p>(no state selected)</p></div>
	
	<div id="id1"></div>
		<br></br>
	<b>
		<font color='red'>
			<a name='reportref'>Report Metadata:</a>
		</font>
	</b>
	<php>
		<a href='#top'>Back to top</a>
	</php>
		<ul>

<li><b>areaname: </b>	The name given to the specified geographic area.</li>
<li><b>areasymbol: </b>	A symbol that uniquely identifies a single occurrence of a particular type of area (e.g. Lancaster Co., Nebraska is NE109).</li>
<li><b>chkey: </b>	A non-connotative string of characters used to uniquely identify a record in the Horizon table.</li>
<li><b>claytotal_r: </b>	Mineral particles less than 0.002mm in equivalent diameter as a weight percentage of the less than 2.0mm fraction.</li>
<li><b>cokey: </b>	A non-connotative string of characters used to uniquely identify a record in the Component table.</li>
<li><b>compname: </b>	Name assigned to a component based on its range of properties.</li>
<li><b>comppct_r: </b>	The percentage of the component of the mapunit.</li>
<li><b>hzdepb_r: </b>	The distance from the top of the soil to the base of the soil horizon.</li>
<li><b>hzdept_r: </b>	The distance from the top of the soil to the upper boundary of the soil horizon.</li>
<li><b>musym: </b>	The symbol used to uniquely identify the soil mapunit in the soil survey.</li>
<li><b>hzname: </b>The concatenated string of four kinds of symbols (five data elements) used to distinguish different kinds of layers in the soil.  (SSM)</li>
<li><b>mukey: </b>	A non-connotative string of characters used to uniquely identify a record in the Mapunit table.</li>
<li><b>muname: </b>	Correlated name of the mapunit (recommended name or field name for surveys in progress).</li>
<li><b>musym: </b>	The symbol used to uniquely identify the soil mapunit in the soil survey.</li>
<li><b>sandmed_r: </b>	Mineral particles 0.25mm to 0.5mm in equivalent diameter as a weight percentage of the less than 2 mm fraction.</li>
<li><b>sandtotal_r: </b>	Mineral particles 0.05mm to 2.0mm in equivalent diameter as a weight percentage of the less than 2 mm fraction.</li>
<li><b>silttotal_r: </b>	Mineral particles 0.002 to 0.05mm in equivalent diameter as a weight percentage of the less than 2.0mm fraction.</li>
<li><b>Soil_Web:</b> Link to Soil Web by Map Unit Key </li>
<li><b>soil_series_extent:</b> Link to Soil Series extent (SSE.) This website is accessible via SEE, or can be used by appending a soil series name to the end of the URL. SDE integrates KSSL, SSURGO, block diagrams, OSD, and SC databases. SEE allows users to explore the spatial extent of soil types nationwide. </li>
<li><b>soil_data_explorer:</b>Link to Soil Data Explorer (SDE.) This website is accessible via SDE, or can be used by appending a soil series name to the end of the URL. SDE integrates KSSL, SSURGO, block diagrams, OSD, and SC databases.
<li><b>silt_clay_ratio</b> Total Silt divided by Total Clay ratio</li>
<li><b>med_sand_ratio</b>  Medium Sand divided Total Sand ratio</li>
		</ul>

	<b>
		<font color='red'>
			<a name='reportref'>Report Description  :</a>
		</font>
	</b>

<p>The suitability of the material for specific purposes is not evaluated, nor are factors that affect excavation of the material. The properties used to evaluate the soil as a source of particle size are gradation of grain sizes (as indicated by the Unified classification of the soil), the thickness of suitable material, and the content of rock fragments.  The ratings are for the whole soil, from the surface to a depth of about 6 feet.</p>
<p>Information in this table is intended for land use planning, for evaluating land use alternatives, and for planning site investigations prior to design and construction. The information, however, has limitations. For example, estimates and other data generally apply only to that part of the soil between the surface and a depth of 5 to 7 feet. Because of the map scale, small areas of different soils may be included within the mapped areas of a specific soil.</p>
<p>The information is not site specific and does not eliminate the need for onsite investigation of the soils or for testing and analysis by personnel experienced in the design and construction of engineering works. </p>	
	<script>
	
	</script>
	<script>
		var url =  "https://sdmdataaccess.sc.egov.usda.gov/tabular/post.rest";
		var stateId = "";
		// Wait for everything to be loaded before starting the first SDA request
		$(document).ready(function(){
			// Start by retrieving a state list
			var data = {
				query: "select statename, stateid from state  WHERE stateid IN ('DC','DE','FL','IN','MD','MI','NJ','PA','WA','WI','WY')order by statename;",
				format: "json"
			}
			$.post(url, data, function( callbackData ) {
					loadSelect("selectId1", callbackData.Table, 1, 0, "select a state");
				}, 
				"json");
		});
		
		function loadSelect(id, table, valueColumn, labelColumn, hintOption) {
			// Add options to the specified select list. The content of the table[valueColumn]
			// defines the value of the selection, the table[labelColumn] is used for the 
			// displayed option's text.
			var iRow = 0;
			$("#" + id)[0].innerHTML = "<option value='' style='display: none' id='remove'>(" + hintOption + ")</option>";
			while (iRow < table.length) {
				var row = table[iRow];
				var optionHtml = "<option value='" + row[valueColumn] + "'>" + row[labelColumn] + "</option>";
				$("#" + id).append(optionHtml);
				iRow++;
			}
		}
 
		function ChangeSelectedState(event) {
			// Update the selected state text area and then fetch and display report 1 results
			var stateId = event.target.value;
			var notification = $("#selectedStateId");
			notification[0].innerHTML = "<p>selected stateId = " + stateId + "</p>";
			
			var query = 
			
"	SELECT  LEFT (areasymbol,2) AS state_sym,  areaname, REPLACE (CONCAT ('<a target=zz_blankzz href=zz' ,'http://websoilsurvey.nrcs.usda.gov/app/WebSoilSurvey.aspx?aoissa=', areasymbol, 'zz>', areasymbol,'</a>'), 'zz', '''') AS areasymbol, muname, musym, mu.mukey, compname, c.cokey,  comppct_r, hzname, hzdept_r, hzdepb_r,  sandtotal_r, silttotal_r, sandmed_r, claytotal_r,"
+ " REPLACE (CONCAT ('<a target=zz_blankzz href=zz' ,'https://casoilresource.lawr.ucdavis.edu/soil_web/ssurgo.php?action=explain_mapunit&mukey=', mu.mukey, 'zz>Click Here</a>'), 'zz', '''') AS [soil_web_link] ,"
+ " CASE WHEN compkind = 'series' THEN REPLACE (CONCAT ('<a target=zzzzz_blankzzzzz href=zzzzz' ,'https://casoilresource.lawr.ucdavis.edu/see/#', compname, 'zzzzz>Click Here</a>'), 'zzzzz', '''') ELSE '' END AS [soil_series_extent], "
+ " CASE WHEN compkind = 'series' THEN REPLACE (CONCAT ('<a target=zzzzz_blankzzzzz href=zzzzz' ,'https://casoilresource.lawr.ucdavis.edu/sde/?series=', compname, 'zzzzz>Click Here</a>'), 'zzzzz', '''') ELSE '' END AS [soil_data_explorer], "
+ " LEFT (ROUND (CASE WHEN  silttotal_r = 0 THEN 0 WHEN claytotal_r = 0 THEN 0 ELSE [silttotal_r]/[claytotal_r] END,2),4) AS silt_clay_ratio, "
+ " LEFT (ROUND ([sandmed_r]/[sandtotal_r],2),4) AS med_sand_ratio, chkey "

+ " FROM legend  AS l "
+ " INNER JOIN mapunit AS mu ON mu.lkey=l.lkey AND LEFT(l.areasymbol,2)  = '" + stateId + "'"
+ " INNER JOIN  component AS c ON c.mukey = mu.mukey  AND majcompflag = 'Yes' "
+ " INNER JOIN  chorizon AS ch ON c.cokey = ch.cokey AND ([sandtotal_r] BETWEEN 60 AND 65 AND [claytotal_r] IS NOT NULL AND [silttotal_r] IS NOT NULL AND [sandmed_r] IS NOT NULL "
+ "  AND CASE WHEN  silttotal_r = 0 THEN 0 WHEN claytotal_r = 0 THEN 0 ELSE [silttotal_r]/[claytotal_r] END BETWEEN 0.75 AND 1 )"
//AND LEFT (ROUND ([sandmed_r]/[sandtotal_r],2),4) >= .0
+ " GROUP BY areaname, areasymbol, muname,  mu.mukey, musym,compname, c.cokey,  comppct_r, hzname, hzdept_r, hzdepb_r,  sandtotal_r, silttotal_r, sandmed_r, claytotal_r, chkey, compkind "
+ " ORDER BY areasymbol ASC,areaname,  musym ASC,muname, mu.mukey, comppct_r DESC, c.cokey, hzdept_r ASC, chkey	"	

;
					
			var data = {
				query: query,
				format: "json+columnname"
			}
			//+ " AND LEFT (ROUND ([sandmed_r]/[sandtotal_r],2),4) >= .40 ) "
			$.post(url, data, function( callbackData ) {
				// the success callback function: when executed add content to table
					$('#id1')[0].innerHTML = "";
					var tableHtml = '<table border="1">';
					// for each row...
					                var iRow = 0;
                while (iRow < callbackData.Table.length) {
                                var row = callbackData.Table[iRow];
                                tableHtml += "<tr>";
                                // for each column in each row...
                                var iCol = 0;
                                while (iCol < row.length) {
                                                if (iRow == 0) {
                                                                tableHtml += "<th>" + row[iCol] + "</th>";
                                                } else {
                                                                tableHtml += "<td>" + row[iCol] + "</td>";
                                                }
                                                iCol++;
                                };
                                tableHtml += "</tr>";                                  
                                iRow++;
                };

					tableHtml += '</table>'
					$('#id1').append(tableHtml);
				}, 
				// Specify that we want the request to be sent in JSON format
				"json");			
			
				
		}
	</script>
	
	<!--Start Map -->
		<div id="map" class="sidebar-map" style="height: 100%;"></div>
 <script src="https://turbo87.github.io/sidebar-v2/js/leaflet-sidebar.js"></script>
	
	<script type="text/javascript">
	var wssUrl;
		if (window.location.hostname.toLowerCase() != 'localhost') {
			// Normal SDA environments
			// "https://SDMDataAccess.sc.egov.usda.gov/Spatial/SDM.wms"
			wmsUrl = '../spatial/SDM.wms';
			wfsWgs84Url = '../spatial/SDMWGS84Geographic.wfs';
			wfsWmUrl = '../spatial/SDMWM.wfs';
			// "https://sdmdataaccess.sc.egov.usda.gov/tabular/post.rest";
			postRestUrl = '../tabular/post.rest';
			if (window.location.hostname.toLowerCase().includes('.dev.')) {
				wssUrl = 'https://websoilsurvey-dev.dev.sc.egov.usda.gov/App/WebSoilSurvey.aspx';
			} else {
				wssUrl = 'https://websoilsurvey.sc.egov.usda.gov/App/WebSoilSurvey.aspx';
			}
		} else {
			// "Localhost" development environment
			wmsUrl = '../../spatial/SDM.wms'
			wfsWgs84Url = '../../spatial/SDMWGS84Geographic.wfs';
			wfsWmUrl = '../../spatial/SDMWM.wfs';
			postRestUrl = '../../sdmtabularservice/tabular/post.rest';
			wssUrl = 'https://websoilsurvey.sc.egov.usda.gov/App/WebSoilSurvey.aspx';
		}
		
		// map-related globals
		var zoomLevel = 15;
		var minZoom = 7;
		
		// container for the identification popup
		var popup = L.popup();
		// The click-selected mupolygon 
		var mupolygonkey = '';		
		// holder for selected polygon boundary
		var features = [];	
		// an AOI approximation when zoomed out
		var aoiPlaceholder;
		// the Leaflet map object
		var map;
		
		// The state of the map
		var mapState = {
			focalPoint: L.latLng(39.833, -98.583),	// roughly center of the lower 48
			foreground: {
				maplayer: null,
				layers: [],
				ids: {
					isNoId: true,
					isAoiid: false,
					isInterpresultid: false,
					isThematicmapid: false,
					aoiid: null,
					interpresultid: null,
					thematicmapid: null,
					sld_id: null,
				},
				isWm: true,
				isWgs84: false,
				crs: L.CRS.EPSG3857
			},
			background: {
				maplayer: null,
				isOsm: true,
				isBingAerial: false,
				isBingRoad: false,
				isBingAerialWithLabels: false,
				isNoBackground: false,
				bingkey: null
			},
			aoicoords: null
		};	
	// Populate Sidebar layers & ids menu
		function populateLayersMenu(xml){
			// Define the Soils layer choices
			var layersMenuHtml = "<tr><td><h3>Soils</h3></td></tr>";				
			layersMenuHtml += "<tr><td>Select layers and options, then click <input type='button' value='update map' name='bUpdateForeground'></div></td></tr>";
			
			var xmlDoc = $.parseXML(xml);
			var elements = xmlDoc.getElementsByTagName('Query');
			for (var ie = 0; ie < elements.length; ie++) {
				var layerName = elements[ie].attributes.typeName.value;					
				if (layerName.toLowerCase() == "mapunitpoly") {
					layersMenuHtml +=
						"<tr><td><input type='checkbox' id='" + layerName + "'name='" + layerName + "' checked>" + layerName + "</td></tr>";
					mapState.foreground.layers[layerName] = true;
					mapState.foreground.layers.push({name: layerName, value:true});
				} else {
					layersMenuHtml +=
						"<tr><td><input type='checkbox' id='" + layerName + "' name='" + layerName + "'>" + layerName + "</td></tr>";
					mapState.foreground.layers.push({name: layerName, value:false});
				}
			};
		
			// Define AOI id options and projection choices

		}
	
		// helper function: open url in new tab
		function openUrl(url) {
			// We map a backtick to an apostrophe
			window.open(url.replace(/`/g, "'"), '_blank');
		}
		
		// Location functions
		var geolocationLat = null;
		var geolocationLng = null;
		function showError(error) {
			geolocationLat = null;
			geolocationLng = null;
			switch(error.code) {
				case error.PERMISSION_DENIED:
					alert("User denied the request for Geolocation.");
					break;
				case error.POSITION_UNAVAILABLE:
					alert("Location information is unavailable.");
					break;
				case error.TIMEOUT:
					alert("The request to get user location timed out.");
					break;
				case error.UNKNOWN_ERROR:
					alert("An unknown error occurred.");
					break;
			}
		}	
		function getLocation() {
			if (navigator.geolocation) {
				var optn = {
					enableHighAccuracy : true,
					timeout : 30 * 1000,
					maximumAge : 2 * 60 * 1000
				};
				navigator.geolocation.getCurrentPosition(showPosition, showError, optn);
			} else {
				geolocationLat = null;
				geolocationLng = null;
				alert("Geolocation is not supported by this browser.");
			}
		}
		function showPosition(position) {
			geolocationLat = position.coords.latitude;
			geolocationLng = position.coords.longitude;
			$("#locationLatitude").text(geolocationLat);
			$("#locationLongitude").text(geolocationLng);
		}		
		
		// Move current map to location
		function moveToLocation() {
			if (geolocationLat) {
				mapState.focalPoint = L.latLng(geolocationLat, geolocationLng);
				map.panTo(mapState.focalPoint);
			}
		}
		
		// Start WSS at location
		function startWssAtLocation(isStartInNewTab) {
			if (geolocationLat) {
				var radius = 1.0 * $('#wssLocationRadius').val();
				if (radius >= 0.001 && radius <= 0.5) {
					var minX = geolocationLng - radius;
					var minY = geolocationLat - radius;
					var maxX = geolocationLng + radius;
					var maxY = geolocationLat + radius;
					var query = '?location=(' + minX + '%20' + minY + ',' +  maxX + '%20' + maxY +')'
						+ '&marker=(' + geolocationLng + '%20' + geolocationLat + ')';
					if (isStartInNewTab) {
						window.open(wssUrl + query, '_blank');
					} else {
						window.open(wssUrl + query, '_self');
					}
				}
			}
		}
		
		// WGS84 to Web Mercator from WSS "MercatorMath.cs"
		var WEB_MERCATOR_EarthRadius = 6378137;
		var WEB_MERCATOR_MinLatitude = -85.05112878;
		var WEB_MERCATOR_MaxLatitude = 85.05112878;
		var WEB_MERCATOR_MinLongitude = -180;
		var WEB_MERCATOR_MaxLongitude = 180;
		var PROJECTED_MIN_Y = -12932243.111992;
		var PROJECTED_MAX_Y = 12932243.111992;
		var PROJECTED_MIN_X = -20037508.3427892;
		var PROJECTED_MAX_X = 20037508.3427892;	
		
		function clipXMeters(xMeters) {
			if (xMeters < PROJECTED_MIN_X)
				return PROJECTED_MIN_X;
			else if (xMeters > PROJECTED_MAX_X)
				return PROJECTED_MAX_X;
			else
				return xMeters;
		}
		
		function clipYMeters(yMeters) {
			if (yMeters < PROJECTED_MIN_Y)
				return PROJECTED_MIN_Y;
			else if (yMeters > PROJECTED_MAX_Y)
				return PROJECTED_MAX_Y;
			else
				return yMeters;
		}
		
		function latitudeToMeters(lat) {
			var r = lat * Math.PI / 180;
			var a = Math.sin(r);
			return clipYMeters(WEB_MERCATOR_EarthRadius / 2 * Math.log((1 + a) / (1 - a)));
		}
		
		function longitudeToMeters(lng) {
			return clipXMeters(WEB_MERCATOR_EarthRadius * (lng * Math.PI / 180));
		}
		
		// Populate (or re-populate) links menu
		function populateLinksMenu() {
			var layerstring =  mapState.foreground.layers.filter(elem => elem.value).map(elem => elem.name).join();
			if (layerstring) {
				mapState.focalPoint = map.getCenter();
				
				var linksMenuHtml = "<tr><td>Remember:&nbsp;</td><td><input type='button' onclick='populateLinksMenu();' value='update links'/></td></tr>";
				linksMenuHtml += "<tr><td>&nbsp;</td><td>&nbsp;</td></tr>";
				/*
				// map size pixel bounds projected coordinates
				linksMenuHtml += "<tr><td>center (lng, lat)&nbsp;&nbsp;</td><td>(" + mapState.focalPoint.lng + "," + mapState.focalPoint.lat + ")</tr>";
				// current map extent
				linksMenuHtml += "<tr><td>bounds&nbsp;&nbsp;</td><td>" + map.getBounds().toBBoxString() + "</tr>";
				// map size pixels
				linksMenuHtml += "<tr><td>size&nbsp;&nbsp;</td><td>" + map.getSize() + "</tr>";
				// map size pixel bounds
				linksMenuHtml += "<tr><td>pixel bounds center&nbsp;&nbsp;</td><td>" + map.getPixelBounds().getCenter() + "</tr>";
				// map size pixel bounds lower left 
				linksMenuHtml += "<tr><td>pixel bounds LL&nbsp;&nbsp;</td><td>" + map.getPixelBounds().getBottomLeft() + "</tr>";
				// map size pixel bounds upper right
				linksMenuHtml += "<tr><td>pixel bounds UR&nbsp;&nbsp;</td><td>" + map.getPixelBounds().getTopRight() + "</tr>";
				// orign pixel
				linksMenuHtml += "<tr><td>pixel origin&nbsp;&nbsp;</td><td>" + map.getPixelOrigin() + "</tr>";
				// latLngToLayerPoint
				linksMenuHtml += "<tr><td>latLngToLayerPoint&nbsp;&nbsp;</td><td>" + map.latLngToLayerPoint(mapState.focalPoint) + "</tr>";
				*/
				
				linksMenuHtml += "<tr><td colspan='2'>The following links open new tabs.</td></tr>";
				linksMenuHtml += "<tr><td>&nbsp;</td><td>&nbsp;</td></tr>";

				// general helper variables
				var focalPointPixels = map.latLngToLayerPoint(mapState.focalPoint);
				var idString = 
					(mapState.foreground.ids.isAoiid ? "&aoiid=" + mapState.foreground.ids.aoiid : "") 					
					+ (mapState.foreground.ids.isThematicmapid ? "&thematicmapid=" + mapState.foreground.ids.thematicmapid : "") 
					+ (mapState.foreground.ids.sld_id ? "&sld_id=" + mapState.foreground.ids.sld_id : "" );
				
				// Note that we are always called at the center
				// WGS84 helper variables
				var wgs84Srs = "EPSG:4326";
				var deltaX = Math.abs(map.getBounds().getEast() - map.getBounds().getWest());
				var deltaY = Math.abs(map.getBounds().getNorth() - map.getBounds().getSouth());
				var wgs84Width = map.getSize().x;
				var wgs84Height = Math.round(map.getSize().x * deltaY / deltaX);				
				var wgs84BBox = map.getBounds().toBBoxString();
				var wgs84FocalPointPixelX = Math.round(wgs84Width/2);
				var wgs84FocalPointPixelY = Math.round(wgs84Height/2);
				
				// WM helper variables
				var wmSrs = "EPSG:3857";
				// convert bounds from WGS84 to Web Mercator
				var xWest = longitudeToMeters(map.getBounds().getWest());
				var xEast = longitudeToMeters(map.getBounds().getEast());
				var ySouth = latitudeToMeters(map.getBounds().getSouth());
				var yNorth = latitudeToMeters(map.getBounds().getNorth());
				var wmWidth = map.getSize().x;
				var wmHeight = map.getSize().y;
				var wmBBox = [xWest, ySouth, xEast, yNorth].join();
				var wmFocalPointPixelX = Math.round(wmWidth/2);
				var wmFocalPointPixelY = Math.round(wmHeight/2);
			
				// WGS84 GetMap
				var wgs84GetMapUrl = 
					wmsUrl + "?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS="
					+ layerstring + "&srs=" + wgs84Srs + "&bbox=" + wgs84BBox
					+ "&width=" + wgs84Width + "&height=" + wgs84Height
					+ "&format=image/png&transparent=true"
					+ idString;
				linksMenuHtml += "<tr><td>GetMap (WGS84)&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wgs84GetMapUrl+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";
				
				// WM GetMap - assumes that the map.getSize() applies
				var wmGetMapUrl = wmsUrl + "?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS="
					+ layerstring + "&srs=" + wmSrs + "&bbox=" + wmBBox
					+ "&width=" + wmWidth + "&height=" + wmHeight
					+ "&format=image/png&transparent=true"
					+ idString;
				linksMenuHtml += "<tr><td>GetMap (WM)&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wmGetMapUrl+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";
			
				// WGS84 GetFeatureInfo (text and gml2)
				var wgs84GetFeatureInfoUrlText =
					wmsUrl + "?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo"
					+ "&QUERY_LAYERS=" + layerstring + "&LAYERS=" + layerstring 
					+ "&srs=" + wgs84Srs + "&bbox=" + wgs84BBox
					+ "&width=" + wgs84Width + "&height=" + wgs84Height
					+ "&x=" + wgs84FocalPointPixelX + "&y=" + wgs84FocalPointPixelY
					+ "&INFO_FORMAT=text/plain"
					+ idString;
				linksMenuHtml += "<tr><td>GetFeatureInfo (WGS84, text)&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wgs84GetFeatureInfoUrlText+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";
				var wgs84GetFeatureInfoUrlGml2 =
					wmsUrl + "?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo"
					+ "&QUERY_LAYERS=" + layerstring + "&LAYERS=" + layerstring 
					+ "&srs=" + wgs84Srs + "&bbox=" + wgs84BBox
					+ "&width=" + wgs84Width + "&height=" + wgs84Height
					+ "&x=" + wgs84FocalPointPixelX + "&y=" + wgs84FocalPointPixelY
					+ "&INFO_FORMAT=gml2"
					+ idString;
				linksMenuHtml += "<tr><td>GetFeatureInfo (WGS84, gml2)&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wgs84GetFeatureInfoUrlGml2+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";

				// WM GetFeatureInfo (text and gml2)
				var wmGetFeatureInfoUrlText =
					wmsUrl + "?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo"
					+ "&QUERY_LAYERS=" + layerstring + "&LAYERS=" + layerstring 
					+ "&srs=" + wmSrs + "&bbox=" + wmBBox
					+ "&width=" + wmWidth + "&height=" + wmHeight
					+ "&x=" + wmFocalPointPixelX + "&y=" + wmFocalPointPixelY
					+ "&INFO_FORMAT=text/plain"
					+ idString;
				linksMenuHtml += "<tr><td>GetFeatureInfo (WM, text)&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wmGetFeatureInfoUrlText+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";
				var wmGetFeatureInfoUrlGml2 =
					wmsUrl + "?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo"
					+ "&QUERY_LAYERS=" + layerstring + "&LAYERS=" + layerstring 
					+ "&srs=" + wmSrs + "&bbox=" + wmBBox
					+ "&width=" + wmWidth + "&height=" + wmHeight
					+ "&x=" + wmFocalPointPixelX + "&y=" + wmFocalPointPixelY
					+ "&INFO_FORMAT=gml2"
					+ idString;
				linksMenuHtml += "<tr><td>GetFeatureInfo (WM, gml2)&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wmGetFeatureInfoUrlGml2+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";

				// WGS84 GetFeature		
				var wgs84GetFeatureUrlBase =
					wfsWgs84Url + "?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetFeature"
					+ "&srsname=" + wgs84Srs 
					+ idString;
				for (i = 0; i < mapState.foreground.layers.length; i++ ) {
					if (mapState.foreground.layers[i].value) {
						var name = mapState.foreground.layers[i].name;
						var wgs84GetFeatureUrlMukeyList = 
							wgs84GetFeatureUrlBase + "&typename=" + name + "&bbox=" + wgs84BBox
							+ "&OUTPUTFORMAT=XMLmukeylist";
						linksMenuHtml += "<tr><td>GetFeature (WGS84, whole map, mukeylist, " + name + ")&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wgs84GetFeatureUrlMukeyList+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";						
						var pointFilter =
							"&Filter=<Filter><DWithin><PropertyName>Geometry</PropertyName><gml:Point>"
							+ "<gml:coordinates>" + mapState.focalPoint.lng + "," + mapState.focalPoint.lat
							+ "</gml:coordinates></gml:Point><Distance%20units=`m`>0</Distance>"
							+ "</DWithin></Filter>";
						var wgs84GetFeatureUrlGml = 
							wgs84GetFeatureUrlBase + "&typename=" + name
							+ "&OUTPUTFORMAT=gml2" + pointFilter;
						linksMenuHtml += "<tr><td>GetFeature (WGS84, point, mukeylist, " + name + ")&nbsp;&nbsp;</td><td onclick='openUrl(\"" + wgs84GetFeatureUrlGml+ "\")' style='color:blue;text-decoration: underline;'>(click to open tab)</td></tr>";					
					}
				}
				
				$('#wfsWmsLinks').html(linksMenuHtml);	
				
			}
		}
		// The following Bing key is provided for USDA-use only.
		var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});
		//var bingTiles = new L.BingLayer("AmmH5JF22z1SVTlmW5RBL9Qs24jux_Rn2C6MSGoRHohVCySTPQBcsOf4VEqIvtye", {type: 'Aerial'});
		var map = L.map('map').setView([38.5643, -121.5838], 14);
		
		var features = [];	// holder for selected polygon boundary
		map.defaults = {
			icon: new L.Icon({
				iconUrl: 'red_dot.png',
				iconSize: [16, 16],
				iconAnchor: [8, 8],
				shadowUrl: 'dot_shadow.png',
				shadowSize: [16, 16],
				shadowAnchor: [8, 8]
			}),
			editable: true,
			color: '#AA0000',
			weight: 3,
			opacity: 1.0,
			editable: true,
			fillColor: '#AA0000',
			fillOpacity: 0.2
        };
			
		// start the map in Fort Collins CO
		map.setView(new L.LatLng(43.0766, -89.4125),14);function onLocationFound(e) {
		var radius = e.accuracy / 2;

		L.marker(e.latlng).addTo(map)
			.bindPopup("You are within " + radius + " meters from this point").openPopup();

		L.circle(e.latlng, radius).addTo(map);
	}

	function onLocationError(e) {
		alert(e.message);
	}

	map.on('locationfound', onLocationFound);
	map.on('locationerror', onLocationError);

	map.locate({setView: true, maxZoom: 16});
		map.addLayer(Esri_WorldImagery);
		L.tileLayer.wms("https://SDMDataAccess.sc.egov.usda.gov/Spatial/SDM.wms", {
            layers: 'mapunitpoly',
            format: 'image/png',
            transparent: true,
            attribution: "SDA WMS",
            maxZoom: 18,
            minZoom: 10,
        }).addTo(map);
		
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		
		var popup = L.popup();
		
		function onMapClick(e) {
			var url =  "HTTPS://sdmdataaccess.sc.egov.usda.gov/tabular/post.rest";
			var wkt = "point(" + e.latlng.lng + " " + e.latlng.lat + ")";
			// carry the coordinates along as the first returned record set. What a hack!
			var query1 = 
				"select " + e.latlng.lat + " [lat], " + e.latlng.lng + " [lng];";
			var query2 = 
				"select top 1 MU.musym, MU.nationalmusym, MU.muname, MU.farmlndcl "
				+ "from mapunit MU, "
				+ "SDA_Get_Mukey_from_intersection_with_WktWgs84('" + wkt + "') K "
				+ "where MU.mukey = K.mukey;";
			// An SDA User Defined Function (SDA_Get_Mupolygonkey_from_intersection_with_WktWgs84)
			// is used to greatly optimize the spatially-indexed retrieval.
			// See https://sdmdataaccess.sc.egov.usda.gov/documents/AdvancedQueries.html .
			
			
			
			var query3 = 
				"select top 1 mupolygongeo from mupolygon MU, "
				+ "SDA_Get_Mupolygonkey_from_intersection_with_WktWgs84('" + wkt + "') K "
				+ "where MU.mupolygonkey = K.mupolygonkey;";
			var data = {
				query: query1 + query2 + query3,
				format: "json+columnname"
			};
			
			$.post(url, data, function( callbackData ) {
					// The first returned Table has the lat, long in the second row.
					var latlngTable = callbackData.Table;
					var latlng = [latlngTable[1][0], latlngTable[1][1]]
					// the second table has the column names and values
					var payloadTable = callbackData.Table1;
					var content = "<table>";
					icol = 0;
					while (icol < payloadTable[0].length) {
						content += "<tr><td>" + payloadTable[0][icol] + "</td><td>" + payloadTable[1][icol] + "</td></tr>";
						icol++;
					};
					// the third table contains the identified polygon as WKT,
					// convert to a Leaflet geometry
					for (i in features) {
						if (features.hasOwnProperty(i)) {
							map.removeLayer(features[i]);
						};
					};
					features.length = 0;
					var polyWktTable = callbackData.Table2;
					var polyWkt = polyWktTable[1][0];
					wkt = new Wkt.Wkt(polyWkt);
					obj = wkt.toObject(map.defaults);
					if (Wkt.isArray(obj)) { // Distinguish multigeometries (Arrays) from objects
						for (i in obj) {
							if (obj.hasOwnProperty(i) && !Wkt.isArray(obj[i])) {
								obj[i].addTo(map);
								features.push(obj[i]);
							};
						};
					} else {
						obj.addTo(map); // Add it to the map
						features.push(obj);
					};
			
					// Pan the map to the feature
					if (obj.getBounds !== undefined && typeof obj.getBounds === 'function') {
						// For objects that have defined bounds or a way to get them
						map.fitBounds(obj.getBounds());
					} else {
						if (obj.getLatLng !== undefined && typeof obj.getLatLng === 'function') {
							map.panTo(obj.getLatLng());
						};
					};
			
					popup
						.setLatLng(latlng)
						.setContent(content)
						.openOn(map);
				}, 
				"json");				
		};

		map.on('click', onMapClick);
		
		var GooglePlacesSearchBox = L.Control.extend({
  onAdd: function() {
    var element = document.createElement("input");
    element.id = "searchBox";
    return element;
  }
});
(new GooglePlacesSearchBox).addTo(map);

var input = document.getElementById("searchBox");
var searchBox = new google.maps.places.SearchBox(input);

searchBox.addListener('places_changed', function() {
  var places = searchBox.getPlaces();

  if (places.length == 0) {
    return;
  }

  var group = L.featureGroup();

  places.forEach(function(place) {

    // Create a marker for each place.
    var marker = L.marker([
      place.geometry.location.lat(),
      place.geometry.location.lng()
    ]);
    group.addLayer(marker);
  });

  group.addTo(map);
  map.fitBounds(group.getBounds());

}


);
		
	</script>
  	<!--End Map -->
</body>
</html>